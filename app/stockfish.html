<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <script>
    const map = {};
    const fen = '8/p3p3/3k4/3P1p2/8/8/5B2/K7 w - -';
    const mode = 'FULL_DEPTH';
    // const mode = 'ONLY_DEPTH';
    const depth = 6;

    if (mode === 'FULL_DEPTH') {
      const goDepth = (depth) => {
        return new Promise((resolve) => {
          const stockfish = new Worker('../node_modules/stockfish/src/stockfish.js');

          stockfish.onmessage = ({ data }) => {
            const nodesCountMatch = data.match(/^Nodes searched: (\d+)/);

            if (nodesCountMatch) {
              resolve(+nodesCountMatch[1]);
            }
          };

          stockfish.postMessage(`position fen ${fen}`);
          stockfish.postMessage('d');
          stockfish.postMessage(`go perft ${depth}`);
        });
      };

      (async () => {
        console.log(
          '[' + (
            await Promise.all(
              new Array(depth).fill(0).map((_, depth) => goDepth(depth + 1))
            )
          )
            .map((res) => (
              [
                ...[...res.toString()]
                  .reverse()
                  .join('')
                  .replace(/\d\d\d/g, '$&_')
                  .replace(/_$/, '')
              ].reverse().join('')
            ))
            .join(', ') + ']'
        );
      })();
    } else {
      const stockfish = new Worker('../node_modules/stockfish/src/stockfish.js');

      stockfish.onmessage = ({ data }) => {
        const match = data.match(/^([a-h1-8]{4}[qnbr]?): (\d+)/);

        if (match) {
          map[match[1]] = +match[2];
        }

        if (!data) {
          console.log(JSON.stringify(map, null, 2));
        }

        const nodesCountMatch = data.match(/^Nodes searched: \d+/);

        if (nodesCountMatch) {
          console.log(data);
        }
      };

      stockfish.postMessage(`position fen ${fen}`);
      stockfish.postMessage('d');
      stockfish.postMessage(`go perft ${depth}`);
    }
  </script>
</head>
<body>

</body>
</html>
